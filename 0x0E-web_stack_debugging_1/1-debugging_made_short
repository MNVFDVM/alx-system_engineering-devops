#!/usr/bin/env bash
# This script configures the Nginx server to listen on port 80 and restarts the service

# Ensure script is executed with root privileges
if [ "$(id -u)" -ne 0 ]; then
    echo "This script must be run as root" >&2
    exit 1
fi

# Check if Nginx is installed, install if not
if ! command -v nginx &> /dev/null; then
    echo "Nginx is not installed. Installing Nginx..."
    apt-get update
    apt-get install -y nginx
fi

# Update Nginx configuration to listen on port 80
NGINX_CONF="/etc/nginx/sites-enabled/default"
if [ -f "$NGINX_CONF" ]; then
    echo "Configuring Nginx to listen on port 80..."
    sed -i 's/listen 8080;/listen 80;/g' "$NGINX_CONF"
else
    echo "Nginx configuration file not found at $NGINX_CONF"
    exit 1
fi

# Restart Nginx to apply the changes
echo "Restarting Nginx..."
if ! service nginx restart; then
    echo "Failed to restart Nginx. Please check the configuration."
    exit 1
fi

# Check if Nginx is listening on port 80
if ss -tuln | grep -q ':80'; then
    echo "Nginx is successfully listening on port 80."
else
    echo "Nginx is not listening on port 80. Please check the configuration."
    exit 1
fi

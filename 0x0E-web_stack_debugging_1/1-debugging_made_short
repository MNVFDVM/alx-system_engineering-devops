#!/usr/bin/env bash
# This script configures Nginx to listen on port 80 and restarts the service

# Ensure the script is executed with root privileges
if [ "$(id -u)" -ne 0 ]; then
    echo "This script must be run as root" >&2
    exit 1
fi

# Check if Nginx is installed, install if not
if ! command -v nginx &> /dev/null; then
    echo "Nginx is not installed. Installing Nginx..."
    apt-get update
    apt-get install -y nginx
fi

# Define the Nginx configuration file path
NGINX_CONF="/etc/nginx/sites-enabled/default"

# Ensure the Nginx configuration file exists
if [ -f "$NGINX_CONF" ]; then
    echo "Configuring Nginx to listen on port 80..."
    
    # Use sed to replace any instance of port 8080 with port 80
    sed -i 's/listen 8080;/listen 80;/g' "$NGINX_CONF"
else
    echo "Nginx configuration file not found at $NGINX_CONF" >&2
    exit 1
fi

# Restart Nginx to apply the changes
echo "Restarting Nginx..."
if ! service nginx restart; then
    echo "Failed to restart Nginx. Please check the configuration." >&2
    exit 1
fi

# Check if Nginx is listening on port 80
echo "Verifying if Nginx is listening on port 80..."
if ss -tuln | grep -q ':80'; then
    echo "Nginx is successfully listening on port 80."
else
    echo "Nginx is not listening on port 80. Please check the configuration." >&2
    exit 1
fi

#!/bin/bash

# Install Nginx if it's not installed
if ! command -v nginx &> /dev/null
then
    echo "Nginx not found. Installing Nginx..."
    apt-get update
    apt-get install -y nginx
fi

# Ensure Nginx is listening on port 80
echo "Ensuring Nginx is listening on port 80..."
sed -i '/listen 80 default_server;/d' /etc/nginx/sites-available/default
sed -i '/listen \[::\]:80 default_server;/d' /etc/nginx/sites-available/default

# Re-add the correct listen directives
echo "server {
    listen 80 default_server;
    listen [::]:80 default_server;
    root /var/www/html;
    index index.html;
    server_name _;
    location / {
        try_files \$uri \$uri/ =404;
    }
}" > /etc/nginx/sites-available/default

# Restart Nginx to apply changes
echo "Restarting Nginx..."
systemctl restart nginx

# Verify Nginx is running and listening on port 80
echo "Checking if Nginx is running and listening on port 80..."
if ss -tuln | grep -q ':80'; then
    echo "Nginx is listening on port 80."
else
    echo "Nginx is not listening on port 80. Something went wrong."
fi
